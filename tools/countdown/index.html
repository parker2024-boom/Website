<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>快速倒计时 · Quick Timer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 15px;
            padding-top: env(safe-area-inset-top, 15px);
            padding-bottom: env(safe-area-inset-bottom, 15px);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .back-btn {
            background: #e0e0e0;
            color: #333;
            padding: 10px 18px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .back-btn:hover, .back-btn:active {
            background: #d0d0d0;
        }

        .settings-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 8px 12px;
            color: #666;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .settings-btn:hover {
            color: #333;
        }

        .settings-btn .icon {
            font-size: 22px;
            transition: transform 0.3s;
        }

        .settings-btn:hover .icon {
            transform: rotate(90deg);
        }

        /* 时间显示区域 */
        .display-section {
            text-align: center;
            padding: 25px 15px;
            margin-bottom: 15px;
        }

        .time-display {
            font-size: clamp(3.5rem, 15vw, 5rem);
            font-weight: 700;
            color: #222;
            font-family: 'Segoe UI', 'Courier New', monospace;
            letter-spacing: 3px;
            transition: color 0.3s;
        }

        .time-display.finished {
            color: #e53935;
            animation: pulse 0.5s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.03); }
        }

        .status-text {
            color: #666;
            font-size: 14px;
            margin-top: 8px;
            min-height: 20px;
        }

        .end-time {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
            min-height: 16px;
        }

        /* 进度条 */
        .progress-container {
            width: 100%;
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 100%;
            width: 100%;
            background: #4caf50;
            transition: width 0.3s ease, background 0.5s ease;
            border-radius: 12px;
        }

        .progress-bar.yellow {
            background: #ffb300;
        }

        .progress-bar.red {
            background: #e53935;
        }

        /* 预设按钮区域 */
        .preset-section {
            margin-bottom: 20px;
        }

        .preset-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
            padding-left: 5px;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .preset-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #ccc, transparent);
            margin: 15px 0;
        }

        .preset-btn {
            padding: 14px 8px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            line-height: 1.3;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .preset-btn:active {
            transform: scale(0.96);
        }

        /* 秒级按钮颜色 */
        .preset-grid.seconds .preset-btn:nth-child(1) { background: #E8F5E9; }
        .preset-grid.seconds .preset-btn:nth-child(2) { background: #E3F2FD; }
        .preset-grid.seconds .preset-btn:nth-child(3) { background: #FFF3E0; }
        .preset-grid.seconds .preset-btn:nth-child(4) { background: #F3E5F5; }
        .preset-grid.seconds .preset-btn:nth-child(5) { background: #E0F7FA; }
        .preset-grid.seconds .preset-btn:nth-child(6) { background: #FBE9E7; }

        /* 分钟级按钮颜色 */
        .preset-grid.minutes .preset-btn:nth-child(1) { background: #FFB3BA; }
        .preset-grid.minutes .preset-btn:nth-child(2) { background: #FFDFBA; }
        .preset-grid.minutes .preset-btn:nth-child(3) { background: #FFFFBA; }
        .preset-grid.minutes .preset-btn:nth-child(4) { background: #BAFFC9; }
        .preset-grid.minutes .preset-btn:nth-child(5) { background: #BAE1FF; }
        .preset-grid.minutes .preset-btn:nth-child(6) { background: #E0BBFF; }
        .preset-grid.minutes .preset-btn:nth-child(7) { background: #FFCCE5; }
        .preset-grid.minutes .preset-btn:nth-child(8) { background: #D4E6F1; }
        .preset-grid.minutes .preset-btn:nth-child(9) { background: #FCE4EC; }

        .preset-btn .key-hint {
            font-size: 10px;
            color: #666;
            display: block;
            margin-top: 2px;
        }

        /* 记录清单 */
        .record-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .record-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .clear-btn {
            padding: 5px 12px;
            background: #f5f5f5;
            border: none;
            border-radius: 15px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }

        .clear-btn:hover {
            background: #e0e0e0;
        }

        .record-list {
            margin-bottom: 12px;
        }

        .record-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
        }

        .record-items {
            max-height: 150px;
            overflow-y: auto;
        }

        .record-item {
            font-size: 13px;
            color: #333;
            padding: 6px 8px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 4px;
        }

        .record-empty {
            font-size: 12px;
            color: #aaa;
            font-style: italic;
        }

        /* 控制按钮 */
        .control-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .test-btn {
            padding: 14px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .test-btn:active {
            background: #f0f0f0;
        }

        .stop-btn {
            padding: 16px;
            background: #ff6666;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .stop-btn:active {
            background: #ff4d4d;
        }

        /* 设置弹窗 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #333;
        }

        .modal p {
            font-size: 13px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .setting-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
        }

        .setting-row label {
            min-width: 70px;
            font-size: 14px;
            color: #333;
        }

        .setting-row input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }

        .setting-row span {
            font-size: 13px;
            color: #666;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            border: none;
        }

        .btn-save {
            background: #4caf50;
            color: white;
        }

        .btn-cancel {
            background: #e0e0e0;
            color: #333;
        }

        /* 确认弹窗 */
        .confirm-modal .modal {
            text-align: center;
        }

        .confirm-modal h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }

        /* 响应式 - 大屏幕 */
        @media (min-width: 600px) {
            body {
                max-width: 500px;
                margin: 0 auto;
                padding: 30px;
            }

            .preset-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .preset-btn {
                padding: 22px 15px;
                font-size: 17px;
            }
        }

        /* 横屏适配 */
        @media (max-height: 500px) and (orientation: landscape) {
            .display-section {
                padding: 15px;
            }

            .time-display {
                font-size: 3rem;
            }

            .preset-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .preset-btn {
                padding: 12px 8px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="settings-btn" onclick="openSettings()"><span class="icon">⚙️</span>设置</button>
    </div>

    <div class="display-section">
        <div class="time-display" id="timeDisplay">00:00</div>
        <div class="status-text" id="statusText">请选择一个倒计时<br>Please select a countdown</div>
        <div class="end-time" id="endTime"></div>
    </div>

    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="control-section">
        <button class="stop-btn" id="stopBtn">停止计时 Stop</button>
    </div>

    <div class="preset-section">
        <div class="preset-label">快捷倒计时 Quick Timer</div>
        <div class="preset-grid seconds" id="presetGridSeconds">
            <!-- 秒级按钮由JS生成 -->
        </div>
        <div class="preset-divider"></div>
        <div class="preset-grid minutes" id="presetGridMinutes">
            <!-- 分钟级按钮由JS生成 -->
        </div>
    </div>

    <!-- 记录清单 -->
    <div class="record-section">
        <div class="record-header">
            <span class="record-title">计时记录 Timer Records</span>
            <button class="clear-btn" onclick="clearRecords()">清空 Clear</button>
        </div>
        <div class="record-list" id="completedRecords">
            <div class="record-label">✅ 完整计时 Completed</div>
            <div class="record-items" id="completedItems">
                <div class="record-empty">暂无记录</div>
            </div>
        </div>
        <div class="record-list" id="interruptedRecords">
            <div class="record-label">⏹️ 中断计时 Interrupted</div>
            <div class="record-items" id="interruptedItems">
                <div class="record-empty">暂无记录</div>
            </div>
        </div>
    </div>

    <!-- 设置弹窗 -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h2>按键时间设置 · Preset durations</h2>
            <p>请设置 9 个快捷倒计时时长（单位：分钟，支持小数如 0.5 或分数如 1/2）<br>
            Please set the nine quick countdown durations (unit: minutes)</p>
            <div id="settingsInputs">
                <!-- 由JS生成 -->
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeSettings()">取消 Cancel</button>
                <button class="btn-save" onclick="saveSettings()">保存 Save</button>
            </div>
        </div>
    </div>

    <!-- 确认弹窗 -->
    <div class="modal-overlay confirm-modal" id="confirmModal">
        <div class="modal">
            <h3>已有倒计时在进行<br>A countdown is already running</h3>
            <p>是否停止当前倒计时，并启动新的倒计时？<br>
            Do you want to stop the current countdown and start a new one?</p>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeConfirm(false)">取消 [Esc]<br>Cancel</button>
                <button class="btn-save" onclick="closeConfirm(true)">停止并启动 [Enter]<br>Stop & Start</button>
            </div>
        </div>
    </div>

    <script>
        // 预设时间（分钟）
        // 秒级预设（无快捷键）
        let presetSeconds = [10/60, 20/60, 30/60, 40/60, 50/60, 1.5];
        // 分钟级预设（有快捷键1-9）
        let presetMinutes = [1, 2, 3, 4, 5, 6, 7, 8, 9];

        // 计时器状态
        let totalSeconds = 0;
        let remainingSeconds = 0;
        let timerRunning = false;
        let timerId = null;
        let endTimeStr = '';
        let startTimeStr = ''; // 记录开始时间
        let currentSetMinutes = 0; // 当前设定的分钟数
        let lastSetMinutes = 0; // 上一次设定的分钟数（用于双击重复）

        // 记录清单
        let completedRecords = [];
        let interruptedRecords = [];

        // 声音相关
        let audioContext = null;
        let alarmLoop = false;
        let alarmTimeoutId = null;

        const STORAGE_KEY = 'quick_timer_settings';

        // ========= 初始化 =========
        function init() {
            loadSettings();
            renderPresetButtons();
            updateDisplay();

            // 键盘快捷键
            document.addEventListener('keydown', (e) => {
                // 如果有弹窗打开，处理弹窗快捷键
                const settingsOpen = document.getElementById('settingsModal').classList.contains('show');
                const confirmOpen = document.getElementById('confirmModal').classList.contains('show');

                if (confirmOpen) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        closeConfirm(true);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        closeConfirm(false);
                    }
                    return;
                }

                if (settingsOpen) {
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        closeSettings();
                    }
                    return; // 设置弹窗打开时不响应其他快捷键
                }

                // 正常快捷键 1-9（对应分钟级预设）
                const key = parseInt(e.key);
                if (key >= 1 && key <= 9) {
                    startCountdown(presetMinutes[key - 1]);
                }
                if (e.key === 'Escape' || e.key === ' ') {
                    stopAll();
                }
            });

            // 移动端：点击屏幕时初始化音频上下文（iOS需要用户交互）
            document.addEventListener('touchstart', initAudioContext, { once: true });
            document.addEventListener('click', initAudioContext, { once: true });
        }

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // ========= 设置加载/保存 =========
        function loadSettings() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (Array.isArray(data) && data.length === 9 && data.every(x => typeof x === 'number' && x > 0)) {
                        presetMinutes = data;
                    }
                }
            } catch (e) {
                console.log('加载设置失败', e);
            }
        }

        function saveSettingsToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(presetMinutes));
            } catch (e) {
                console.log('保存设置失败', e);
            }
        }

        // ========= 渲染预设按钮 =========
        function renderPresetButtons() {
            // 渲染秒级按钮（无快捷键）
            const gridSeconds = document.getElementById('presetGridSeconds');
            gridSeconds.innerHTML = '';

            presetSeconds.forEach((minutes) => {
                const btn = document.createElement('button');
                btn.className = 'preset-btn';
                btn.onclick = () => startCountdown(minutes);

                // 格式化显示
                let displayText;
                if (minutes >= 1) {
                    displayText = `${minutes} min`;
                } else {
                    displayText = `${Math.round(minutes * 60)} sec`;
                }

                btn.innerHTML = displayText;
                gridSeconds.appendChild(btn);
            });

            // 渲染分钟级按钮（有快捷键1-8）
            const gridMinutes = document.getElementById('presetGridMinutes');
            gridMinutes.innerHTML = '';

            presetMinutes.forEach((minutes, index) => {
                const btn = document.createElement('button');
                btn.className = 'preset-btn';
                btn.onclick = () => startCountdown(minutes);

                const displayText = `${minutes} min`;
                btn.innerHTML = `${displayText}<span class="key-hint">按键 ${index + 1}</span>`;
                gridMinutes.appendChild(btn);
            });
        }

        // ========= 时间显示 =========
        function updateDisplay() {
            const mm = Math.floor(remainingSeconds / 60);
            const ss = remainingSeconds % 60;
            const timeStr = String(mm).padStart(2, '0') + ':' + String(ss).padStart(2, '0');

            const display = document.getElementById('timeDisplay');
            display.textContent = timeStr;

            // 更新进度条
            const progressBar = document.getElementById('progressBar');
            if (totalSeconds > 0) {
                const percent = Math.max(0, Math.min(100, (remainingSeconds / totalSeconds) * 100));
                progressBar.style.width = percent + '%';

                // 颜色变化
                progressBar.classList.remove('yellow', 'red');
                if (percent <= 20) {
                    progressBar.classList.add('red');
                } else if (percent <= 50) {
                    progressBar.classList.add('yellow');
                }
            } else {
                progressBar.style.width = '100%';
                progressBar.classList.remove('yellow', 'red');
            }
        }

        // ========= 倒计时逻辑 =========
        let pendingMinutes = null;
        let confirmCallback = null;

        function startCountdown(minutes) {
            // 先停止声音
            stopAlarm();

            if (timerRunning) {
                // 显示确认弹窗
                pendingMinutes = minutes;
                document.getElementById('confirmModal').classList.add('show');
                return;
            }

            doStartCountdown(minutes);
        }

        function closeConfirm(confirmed) {
            document.getElementById('confirmModal').classList.remove('show');
            if (confirmed && pendingMinutes !== null) {
                // 记录中断
                if (timerRunning && totalSeconds > 0) {
                    const actualTime = totalSeconds - remainingSeconds;
                    const endTime = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    addRecord('interrupted', currentSetMinutes, startTimeStr, endTime, actualTime);
                }
                stopTimer();
                doStartCountdown(pendingMinutes);
            }
            pendingMinutes = null;
        }

        function doStartCountdown(minutes) {
            // 开始时初始化音频上下文
            initAudioContext();
            
            totalSeconds = Math.max(1, Math.round(minutes * 60));
            remainingSeconds = totalSeconds;
            timerRunning = true;
            lastPlayedPercent = 100; // 重置百分比记录
            currentSetMinutes = minutes; // 记录设定的分钟数
            lastSetMinutes = minutes; // 保存用于双击重复

            // 记录开始时间
            const now = new Date();
            startTimeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // 计算预计结束时间
            const endTime = new Date(Date.now() + remainingSeconds * 1000);
            endTimeStr = endTime.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            document.getElementById('statusText').innerHTML = '正在倒计时…<br>Counting down…';
            document.getElementById('endTime').innerHTML = `结束时间 Ending Time: ${endTimeStr}`;
            document.getElementById('timeDisplay').classList.remove('finished');

            updateDisplay();
            scheduleTick();
        }

        function scheduleTick() {
            if (!timerRunning) return;
            timerId = setTimeout(tick, 1000);
        }

        function tick() {
            if (!timerRunning) return;

            remainingSeconds--;
            
            // 检查是否需要播放声音提示
            checkAndPlaySound();
            
            if (remainingSeconds <= 0) {
                remainingSeconds = 0;
                updateDisplay();
                onTimerFinished();
            } else {
                updateDisplay();
                scheduleTick();
            }
        }

        // 检查并播放声音提示
        let lastBeepTime = 0; // 记录上次Beep的时间戳
        
        function checkAndPlaySound() {
            // 剩余20秒时播放鸟叫
            if (remainingSeconds === 20 && totalSeconds > 20) {
                playSpecialSound(audioBird);
                return;
            }
            
            // 剩余10秒时播放猫叫
            if (remainingSeconds === 10 && totalSeconds > 10) {
                playSpecialSound(audioCat);
                return;
            }
            
            // 每少10%时播放Beep（除非正在播放其他声音）
            // 条件：总时间>=30秒 且 距离上次Beep至少10秒
            if (totalSeconds >= 30 && !isPlayingSpecialSound) {
                const currentPercent = Math.floor((remainingSeconds / totalSeconds) * 100);
                const targetPercent = Math.floor(lastPlayedPercent / 10) * 10 - 10;
                const now = Date.now();
                const timeSinceLastBeep = (now - lastBeepTime) / 1000;
                
                // 跳过10%和20%的beep（这些时间段有猫叫和鸟叫）
                if (currentPercent <= targetPercent && targetPercent >= 30 && timeSinceLastBeep >= 10) {
                    lastPlayedPercent = targetPercent;
                    lastBeepTime = now;
                    playBeepOnce();
                }
            }
        }

        // 播放特殊声音（猫叫/鸟叫）
        function playSpecialSound(audio) {
            if (!audio) return;
            isPlayingSpecialSound = true;
            audio.currentTime = 0;
            audio.play().catch(e => console.log('播放失败', e));
            
            // 声音播放完毕后重置标志
            audio.onended = () => {
                isPlayingSpecialSound = false;
            };
        }

        // 播放一次Beep
        function playBeepOnce() {
            if (!audioBeep) return;
            audioBeep.currentTime = 0;
            audioBeep.play().catch(e => console.log('Beep播放失败', e));
        }

        function stopTimer() {
            timerRunning = false;
            if (timerId) {
                clearTimeout(timerId);
                timerId = null;
            }
        }

        function onTimerFinished() {
            timerRunning = false;
            timerId = null;

            // 停止所有正在播放的特殊声音（猫叫/鸟叫）
            if (audioCat) { audioCat.pause(); audioCat.currentTime = 0; }
            if (audioBird) { audioBird.pause(); audioBird.currentTime = 0; }
            if (audioBeep) { audioBeep.pause(); audioBeep.currentTime = 0; }
            isPlayingSpecialSound = false;

            // 添加完整计时记录
            const endTime = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            addRecord('completed', currentSetMinutes, startTimeStr, endTime);

            document.getElementById('statusText').innerHTML = '⏰ 时间到！<br>Time\'s up!';
            document.getElementById('endTime').textContent = '';
            document.getElementById('timeDisplay').classList.add('finished');

            // 直接播放合成音效闹铃
            playAlarm();
        }

        // ========= 停止所有 =========
        let lastStopClickTime = 0;
        const DOUBLE_CLICK_THRESHOLD = 400; // 双击间隔阈值（毫秒）

        // 初始化停止按钮的点击事件
        document.getElementById('stopBtn').addEventListener('click', function() {
            const now = Date.now();
            if (now - lastStopClickTime < DOUBLE_CLICK_THRESHOLD && lastSetMinutes > 0) {
                // 双击：重复上一次倒计时
                stopAlarm();
                stopTimer();
                resetToIdle();
                doStartCountdown(lastSetMinutes);
            } else {
                // 单击：停止计时
                stopAll();
            }
            lastStopClickTime = now;
        });

        function stopAll() {
            // 如果正在计时，添加中断记录
            if (timerRunning && totalSeconds > 0) {
                const actualTime = totalSeconds - remainingSeconds; // 实际计时秒数
                const endTime = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                addRecord('interrupted', currentSetMinutes, startTimeStr, endTime, actualTime);
            }
            stopTimer();
            stopAlarm();
            resetToIdle();
        }

        function resetToIdle() {
            remainingSeconds = 0;
            totalSeconds = 0;
            endTimeStr = '';

            document.getElementById('timeDisplay').textContent = '00:00';
            document.getElementById('timeDisplay').classList.remove('finished');
            document.getElementById('statusText').innerHTML = '请选择一个倒计时<br>Please select a countdown';
            document.getElementById('endTime').textContent = '';

            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = '100%';
            progressBar.classList.remove('yellow', 'red');
        }

        // ========= 声音相关 =========
        function playAlarm() {
            stopAlarm();
            alarmLoop = true;
            alarmTick();
        }

        function alarmTick() {
            if (!alarmLoop) return;

            // 播放一次提示音
            playBeep();

            // 每2.5秒响一次
            alarmTimeoutId = setTimeout(alarmTick, 2500);
        }

        function stopAlarm() {
            alarmLoop = false;
            if (alarmTimeoutId) {
                clearTimeout(alarmTimeoutId);
                alarmTimeoutId = null;
            }
        }

        // 预加载音频
        let audioCat = null;
        let audioBird = null;
        let audioBeep = null;
        let lastPlayedPercent = 100; // 记录上次播放的百分比
        let isPlayingSpecialSound = false; // 是否正在播放特殊声音

        function preloadAudio() {
            audioCat = new Audio('sounds/cat.mp3');
            audioBird = new Audio('sounds/bird.mp3');
            audioBeep = new Audio('sounds/beep.mp3');
            
            audioCat.load();
            audioBird.load();
            audioBeep.load();
        }
        preloadAudio();

        function playBeep() {
            // 循环闹铃使用备用方案（滴滴滴滴）
            console.log('playBeep called');
            playBeepFallback();
        }

        // 备用方案：Web Audio API
        function playBeepFallback() {
            console.log('playBeepFallback called, audioContext:', audioContext);
            initAudioContext();
            if (!audioContext) {
                console.error('audioContext is null after init');
                return;
            }
            console.log('audioContext state:', audioContext.state);

            try {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const beepDuration = 0.15;
                const beepGap = 0.22;
                const groupGap = 0.4;

                function playOneBeep(startTime) {
                    const frequencies = [659, 880];
                    frequencies.forEach((freq, idx) => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';
                        const volume = idx === 0 ? 0.25 : 0.12;
                        gainNode.gain.setValueAtTime(0, startTime);
                        gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.015);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + beepDuration);
                        oscillator.start(startTime);
                        oscillator.stop(startTime + beepDuration);
                    });
                }

                const now = audioContext.currentTime;
                for (let i = 0; i < 4; i++) {
                    playOneBeep(now + i * beepGap);
                }
                const secondGroupStart = 4 * beepGap + groupGap;
                for (let i = 0; i < 4; i++) {
                    playOneBeep(now + secondGroupStart + i * beepGap);
                }
            } catch (e) {
                console.log('备用声音也失败', e);
            }
        }

        // ========= 设置弹窗 =========
        function openSettings() {
            const container = document.getElementById('settingsInputs');
            container.innerHTML = '';

            presetMinutes.forEach((minutes, index) => {
                const row = document.createElement('div');
                row.className = 'setting-row';

                // 格式化显示值
                let displayVal = minutes === Math.floor(minutes) ? String(minutes) : minutes.toFixed(2).replace(/\.?0+$/, '');

                row.innerHTML = `
                    <label>按键 ${index + 1}：</label>
                    <input type="text" id="setting_${index}" value="${displayVal}">
                    <span>分钟</span>
                `;
                container.appendChild(row);
            });

            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function parseMinutes(str) {
            str = str.trim();
            if (str.includes('/')) {
                const parts = str.split('/');
                if (parts.length === 2) {
                    return parseFloat(parts[0]) / parseFloat(parts[1]);
                }
            }
            return parseFloat(str);
        }

        function saveSettings() {
            const newValues = [];

            for (let i = 0; i < 9; i++) {
                const input = document.getElementById(`setting_${i}`);
                const val = parseMinutes(input.value);

                if (isNaN(val) || val <= 0) {
                    alert('请输入大于 0 的分钟数（支持小数如 0.5 或分数如 1/2）\nPlease enter a value > 0');
                    return;
                }
                newValues.push(val);
            }

            presetMinutes = newValues;
            saveSettingsToStorage();
            renderPresetButtons();
            closeSettings();

            alert('已保存按键时间设置\nPreset durations have been saved');
        }

        // ========= 记录清单 =========
        function addRecord(type, setMinutes, startTime, endTime, actualSeconds = null) {
            const records = type === 'completed' ? completedRecords : interruptedRecords;
            const index = records.length + 1;
            
            // 格式化设定时间
            let setTimeStr;
            if (setMinutes >= 1) {
                setTimeStr = setMinutes === Math.floor(setMinutes) ? `${setMinutes}min` : `${setMinutes.toFixed(1)}min`;
            } else {
                setTimeStr = `${Math.round(setMinutes * 60)}s`;
            }
            
            let recordText;
            if (type === 'completed') {
                recordText = `${index}. 设定${setTimeStr}：${startTime} - ${endTime}`;
            } else {
                // 中断记录显示实际时间
                const actualMin = Math.floor(actualSeconds / 60);
                const actualSec = actualSeconds % 60;
                const actualStr = actualMin > 0 ? `${actualMin}m${actualSec}s` : `${actualSec}s`;
                recordText = `${index}. 设定${setTimeStr}：${startTime} - ${endTime}（实际${actualStr}）`;
            }
            
            records.push(recordText);
            renderRecords();
        }

        function renderRecords() {
            // 渲染完整计时记录
            const completedItems = document.getElementById('completedItems');
            if (completedRecords.length === 0) {
                completedItems.innerHTML = '<div class="record-empty">暂无记录</div>';
            } else {
                completedItems.innerHTML = completedRecords.map(r => `<div class="record-item">${r}</div>`).join('');
            }
            
            // 渲染中断计时记录
            const interruptedItems = document.getElementById('interruptedItems');
            if (interruptedRecords.length === 0) {
                interruptedItems.innerHTML = '<div class="record-empty">暂无记录</div>';
            } else {
                interruptedItems.innerHTML = interruptedRecords.map(r => `<div class="record-item">${r}</div>`).join('');
            }
        }

        function clearRecords() {
            completedRecords = [];
            interruptedRecords = [];
            renderRecords();
        }

        // 启动
        init();
    </script>
</body>
</html>
